<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Procesador de Video</title>
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin">
    <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp">
    
    <style>
        /* Estilos anteriores sin cambios */
    </style>
</head>
<body>
    <h1>Procesador de Video</h1>
    
    <div id="compatibility-check" class="error-message" style="display:none;"></div>
    
    <div id="drop-zone">
        Arrastra y suelta archivos MP4 aquí
        <input type="file" id="file-input" accept="video/mp4" multiple style="display:none;">
    </div>

    <div id="video-config">
        <div class="config-input">
            <label>Bitrate (kbps):</label>
            <input type="number" id="bitrate" value="2000" min="100" max="8000">
        </div>
        <div class="config-input">
            <label>FPS:</label>
            <input type="number" id="fps" value="30" min="1" max="60">
        </div>
        <div class="config-input">
            <label>Buffer Size (kB):</label>
            <input type="number" id="buffsize" value="8192" min="1024" max="8192">
        </div>
        <div class="config-input">
            <label>
                <input type="checkbox" id="keep-audio" checked>
                Mantener Audio
            </label>
        </div>
        <button id="process-btn">Procesar Videos</button>
    </div>

    <div id="progress-container" class="progress-container" style="display:none;">
        <div class="progress-bar" id="progress-bar"></div>
        <div class="progress-details" id="progress-details"></div>
    </div>

    <div id="status"></div>

    <div id="metadata-container" style="margin-top: 20px; background-color: #f4f4f4; padding: 15px; border-radius: 5px;">
        <h3>Informacion de Archivos</h3>
        <div id="metadata-display"></div>
    </div>

    <!-- Configuración global de compatibilidad -->
    <script>
        // Configuración de depuración
        window.DEBUG = {
            ffmpeg: true
        };

        // Función de registro de depuración
        function debugLog(message, ...args) {
            if (window.DEBUG.ffmpeg) {
                console.log(`[FFmpeg Debug] ${message}`, ...args);
            }
        }

        window.crossOriginIsolated = true;
        
        // Función de utilidad para cargar archivos
        async function fetchFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    debugLog('Archivo leído:', file.name);
                    resolve(new Uint8Array(reader.result));
                };
                reader.onerror = (error) => {
                    debugLog('Error leyendo archivo:', error);
                    reject(error);
                };
                reader.readAsArrayBuffer(file);
            });
        }

        // Fallback para FFmpeg con más información de depuración
        window.FFmpeg = window.FFmpeg || {};
        window.FFmpeg.createFFmpeg = window.FFmpeg.createFFmpeg || function(config) {
            debugLog('Usando FFmpeg fallback simulado', config);
            return {
                load: async () => {
                    debugLog('Carga simulada de FFmpeg');
                    throw new Error('FFmpeg no está correctamente inicializado');
                },
                FS: (operation, ...args) => {
                    debugLog(`Operación FS simulada: ${operation}`, args);
                    return null;
                },
                run: async () => {
                    debugLog('Procesamiento simulado de FFmpeg');
                    throw new Error('Procesamiento de FFmpeg no disponible');
                },
                setLogger: (logger) => {
                    debugLog('Logger simulado establecido');
                }
            };
        };
    </script>

    <!-- Scripts de FFmpeg -->
    <script src="/ffmpeg/ffmpeg.min.js"></script>
    <script src="/ffmpeg/ffmpeg-core.js"></script>
    <script src="/ffmpeg/ffmpeg-core.worker.js"></script>

    <script>
        // Resto del código anterior sin cambios, solo modificaré la sección de procesamiento

        // Procesamiento de video
        processBtn.addEventListener('click', async () => {
            if (currentFiles.length === 0) {
                statusDiv.textContent = 'Por favor, seleccione archivos primero';
                return;
            }

            try {
                // Verificación de FFmpeg con registro detallado
                debugLog('Buscando función createFFmpeg');
                const createFFmpegFunc = window.createFFmpeg || 
                                         window.FFmpeg.createFFmpeg || 
                                         window.FFmpeg?.createFFmpeg;
                
                debugLog('Función createFFmpeg encontrada:', !!createFFmpegFunc);
                
                if (!createFFmpegFunc) {
                    throw new Error('FFmpeg no está definido. Verifica la carga de los scripts.');
                }

                // Cargar FFmpeg
                debugLog('Inicializando FFmpeg');
                const ffmpeg = createFFmpegFunc({ 
                    log: true,
                    corePath: '/ffmpeg/ffmpeg-core.js',
                    mainName: 'main',
                    workerPath: '/ffmpeg/ffmpeg-core.worker.js'
                });
                
                // Configurar logger personalizado
                ffmpeg.setLogger((log) => {
                    debugLog('Log de FFmpeg:', log.message);
                    progressContainer.style.display = 'block';
                    progressDetails.innerHTML += `${log.message}<br>`;
                });

                statusDiv.textContent = 'Cargando FFmpeg...';
                await ffmpeg.load();

                // Procesar cada archivo
                const metadataReports = [];
                for (let index = 0; index < currentFiles.length; index++) {
                    // Resetear progreso
                    progressContainer.style.display = 'block';
                    progressBar.style.width = '0%';
                    progressDetails.innerHTML = '';

                    const currentFile = currentFiles[index];
                    statusDiv.textContent = `Procesando video ${index + 1} de ${currentFiles.length}`;

                    // Extraer metadatos originales
                    const originalMetadata = await extractVideoMetadata(currentFile);

                    // Escribir archivo de entrada
                    debugLog('Escribiendo archivo de entrada');
                    const fileData = await fetchFile(currentFile);
                    debugLog('Datos de archivo leídos:', fileData);
                    
                    ffmpeg.FS('writeFile', 'input.mp4', fileData);

                    // Obtener configuraciones
                    const bitrate = document.getElementById('bitrate').value;
                    const fps = document.getElementById('fps').value;
                    const keepAudio = document.getElementById('keep-audio').checked;

                    // Construir comando FFmpeg
                    const ffmpegCommand = [
                        '-i', 'input.mp4',
                        '-c:v', 'libx264',
                        '-profile:v', 'high',
                        '-level', '4.0',
                        '-b:v', `${bitrate}k`,
                        '-r', fps,
                        keepAudio ? '' : '-an',
                        'output.mp4'
                    ].filter(Boolean);

                    // Procesar video
                    debugLog('Ejecutando comando FFmpeg', ffmpegCommand);
                    await ffmpeg.run(...ffmpegCommand);
                    
                    // Leer archivo de salida
                    debugLog('Leyendo archivo de salida');
                    const data = ffmpeg.FS('readFile', 'output.mp4');
                    debugLog('Datos de salida:', data);

                    // Crear blob y descargar video
                    const blob = new Blob([data.buffer], { type: 'video/mp4' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `processed_${currentFile.name}`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);

                    // Generar informe de metadatos
                    const metadataReport = `
Archivo: ${currentFile.name}

Metadatos Originales:
- Tamaño: ${originalMetadata.size} bytes
- Resolución: ${originalMetadata.resolution}
- Duración: ${originalMetadata.duration} segundos
- FPS Original: ${originalMetadata.fps}
- Bitrate Original: ${originalMetadata.bitrate}
`;
                    metadataReports.push(metadataReport);
                }

                // Descargar informe consolidado
                const consolidatedReport = metadataReports.join('\n\n---\n\n');
                const reportBlob = new Blob([consolidatedReport], { type: 'text/plain' });
                const reportUrl = URL.createObjectURL(reportBlob);
                
                const reportLink = document.createElement('a');
                reportLink.href = reportUrl;
                reportLink.download = 'video_processing_report.txt';
                document.body.appendChild(reportLink);
                reportLink.click();
                document.body.removeChild(reportLink);

                statusDiv.textContent = 'Procesamiento completado';
                currentFiles = []; // Limpiar lista de archivos
                dropZone.textContent = 'Arrastra y suelta archivos MP4 aquí';
                videoConfig.style.display = 'none';
                progressContainer.style.display = 'none';

            } catch (error) {
                console.error('Error de procesamiento:', error);
                statusDiv.textContent = `Error: ${error.message}`;
                
                // Mostrar detalles de depuración
                const debugInfo = `
Detalles de depuración:
- createFFmpeg: ${typeof createFFmpeg}
- FFmpeg global: ${window.FFmpeg}
- Scripts cargados: 
  * ffmpeg.min.js
  * ffmpeg-core.js
  * ffmpeg-core.worker.js
`;
                statusDiv.innerHTML += `<pre>${debugInfo}</pre>`;
            }
        });

        // Resto del código anterior sin cambios
    </script>
</body>
</html>
