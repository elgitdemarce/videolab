<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Procesador de Video</title>
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin">
    <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp">
    
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }
        #drop-zone {
            border: 3px dashed #3498db;
            border-radius: 20px;
            padding: 50px;
            margin: 20px 0;
            transition: all 0.3s ease;
        }
        #drop-zone.drag-over {
            background-color: rgba(52, 152, 219, 0.1);
            border-color: #2980b9;
        }
        #video-config {
            display: none;
            margin-top: 20px;
        }
        .config-input {
            margin: 10px 0;
        }
        #status {
            margin-top: 20px;
            font-weight: bold;
        }
        .error-message {
            color: red;
            background-color: #ffeeee;
            padding: 10px;
            border-radius: 5px;
            margin-top: 20px;
        }
        .progress-container {
            margin: 20px 0;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-bar {
            width: 0;
            height: 20px;
            background-color: #3498db;
            transition: width 0.5s ease;
        }
        .progress-details {
            font-family: monospace;
            text-align: left;
            background-color: #f4f4f4;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>Procesador de Video</h1>
    
    <div id="compatibility-check" class="error-message" style="display:none;"></div>
    
    <div id="drop-zone">
        Arrastra y suelta archivos MP4 aquí
        <input type="file" id="file-input" accept="video/mp4" multiple style="display:none;">
    </div>

    <div id="video-config">
        <div class="config-input">
            <label>Bitrate (kbps):</label>
            <input type="number" id="bitrate" value="2000" min="100" max="8000">
        </div>
        <div class="config-input">
            <label>FPS:</label>
            <input type="number" id="fps" value="30" min="1" max="60">
        </div>
        <div class="config-input">
            <label>Buffer Size (kB):</label>
            <input type="number" id="buffsize" value="8192" min="1024" max="8192">
        </div>
        <div class="config-input">
            <label>
                <input type="checkbox" id="keep-audio" checked>
                Mantener Audio
            </label>
        </div>
        <button id="process-btn">Procesar Videos</button>
    </div>

    <div id="progress-container" class="progress-container" style="display:none;">
        <div class="progress-bar" id="progress-bar"></div>
        <div class="progress-details" id="progress-details"></div>
    </div>

    <div id="status"></div>

    <div id="metadata-container" style="margin-top: 20px; background-color: #f4f4f4; padding: 15px; border-radius: 5px;">
        <h3>Informacion de Archivos</h3>
        <div id="metadata-display"></div>
    </div>

    <script src="/ffmpeg/ffmpeg.min.js"></script>
    <script src="/ffmpeg/ffmpeg-core.js"></script>
    <script src="/ffmpeg/ffmpeg-core.worker.js"></script>
    <script>
        // Definición global de FFmpeg si no existe
        window.FFmpeg = window.FFmpeg || {};
        
        // Función de importación de FFmpeg con fallback
        function importFFmpeg() {
            return new Promise((resolve, reject) => {
                if (typeof createFFmpeg !== 'undefined') {
                    resolve(createFFmpeg);
                } else if (window.FFmpeg && window.FFmpeg.createFFmpeg) {
                    resolve(window.FFmpeg.createFFmpeg);
                } else {
                    // Intentar cargar dinámicamente
                    const script = document.createElement('script');
                    script.src = '/ffmpeg/ffmpeg.min.js';
                    script.onload = () => {
                        if (typeof createFFmpeg !== 'undefined') {
                            resolve(createFFmpeg);
                        } else {
                            reject(new Error('No se pudo cargar FFmpeg'));
                        }
                    };
                    script.onerror = () => reject(new Error('Error cargando script de FFmpeg'));
                    document.head.appendChild(script);
                }
            });
        }

        // Elementos del DOM
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const videoConfig = document.getElementById('video-config');
        const processBtn = document.getElementById('process-btn');
        const statusDiv = document.getElementById('status');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const progressDetails = document.getElementById('progress-details');

        // Estado global
        let currentFiles = [];

        // Configurar eventos de drag and drop
        function setupDragDropEvents() {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            dropZone.addEventListener('dragenter', highlight, false);
            dropZone.addEventListener('dragover', highlight, false);
            dropZone.addEventListener('dragleave', unhighlight, false);
            dropZone.addEventListener('drop', handleDrop, false);

            // Soporte de clic
            dropZone.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileSelect);
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function highlight() {
            dropZone.classList.add('drag-over');
        }

        function unhighlight() {
            dropZone.classList.remove('drag-over');
        }

        async function handleDrop(e) {
            unhighlight();
            const files = e.dataTransfer.files;
            await processFiles(files);
        }

        async function handleFileSelect(e) {
            const files = e.target.files;
            await processFiles(files);
        }

        // Resto del código anterior sin cambios...

        // Modificación en la carga de FFmpeg
        processBtn.addEventListener('click', async () => {
            if (currentFiles.length === 0) {
                statusDiv.textContent = 'Por favor, seleccione archivos primero';
                return;
            }

            try {
                // Importar FFmpeg de manera segura
                const createFFmpegFunc = await importFFmpeg();

                // Cargar FFmpeg
                const ffmpeg = createFFmpegFunc({ 
                    log: true,
                    corePath: '/ffmpeg/ffmpeg-core.js',
                    mainName: 'main',
                    workerPath: '/ffmpeg/ffmpeg-core.worker.js'
                });
                
                // Configurar logger personalizado
                ffmpeg.setLogger((log) => {
                    progressContainer.style.display = 'block';
                    progressDetails.innerHTML += `${log.message}<br>`;
                });

                statusDiv.textContent = 'Cargando FFmpeg...';
                await ffmpeg.load();

                // Resto del código de procesamiento permanece igual...
                // (código de procesamiento de videos)

            } catch (error) {
                console.error('Error de inicialización de FFmpeg:', error);
                statusDiv.textContent = `Error: ${error.message}`;
                
                // Mostrar detalles de depuración
                const debugInfo = `
Detalles de depuración:
- createFFmpeg: ${typeof createFFmpeg}
- FFmpeg global: ${window.FFmpeg}
- Scripts cargados: 
  * ffmpeg.min.js
  * ffmpeg-core.js
  * ffmpeg-core.worker.js
`;
                statusDiv.innerHTML += `<pre>${debugInfo}</pre>`;
            }
        });

        // Inicialización
        function init() {
            setupDragDropEvents();
        }

        // Ejecutar inicialización
        init();
    </script>
</body>
</html>
